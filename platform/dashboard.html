<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="refresh" content="3600">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD >
	<title>Dashboard - Platform</title>
	<script type="text/javascript" src="modevlib/imports/import.js"></script>
</HEAD>
<BODY>
<div style="overflow:hidden;">
	<div id="sidebar">
		<div id="description" style="width:300px;">
			Team manager dashboard
		</div>
		<hr>
		<div id="last-updated" style="text-align: center;width:300px;"></div>
		<hr>
		<div id="filters" style="width:300px;" class="menu">
		</div>
	</div>
	<div class="sidebar_name">
		<div>Team Selection</div>
	</div>
	<div class="content" style="position:inherit;">
		<h3 id="title" style="display:inline-block;">Platform Dashboard</h3>
		<table id="category"></table>
	</div>
	<div class="footer">
		Source at <a href="https://github.com/mozilla/charts/blob/master/fxos/blockers.html">https://github.com/mozilla/charts/blob/master/platform/dashboard.html</a>
	</div>
</div>

<script type="application/javascript">

	importScript('js/main_lib.js', function () {
		sidebarSlider();

		var thread;
		function createChart() {
			if (thread !== undefined)
				thread.kill(true);
			thread = Thread.run(__createChart());
		}
		refresher(createChart);

		var __createChart = function*() {
			yield (ESQuery.loadColumns({"from": "bugs"}));

			var team = GUI.state.team.getSimpleState();

			var teamFilter = {"and": GUI.state.team.getSelectedParts().select("esfilter")};
			$("#title").html(team);

			var temp=$("#category");
			temp.html(Mozilla.Platform.Category.partitions.map(function(category){
				return getCategoryHTML(category, teamFilter)
			}).join(""));
			temp.append(Mozilla.Platform.Track.edges.map(function(category){
				return getCategoryHTML(category, teamFilter)
			}).join(""));
			temp.append(Mozilla.Platform.B2GRelease.edges.map(function(category){
				return getCategoryHTML(category, teamFilter)
			}).join(""));
		};

		$(document).ready(function () {
			GUI.setup(
				createChart,
				[
					{"id": "team", "name": "Teams", "type": PartitionFilter.newInstance({
						"id": "Teams",
						"name": "All Teams",
						"dimension": Mozilla.Platform.Team,
						"onlyOne": false,
						"expandAll": true
					})}
				],
				[],
				null,
				false		//SHOW DEFAULT FILTERS?
			);
		});
	});

	function getCategoryHTML(category, teamFilter){
		var uid = "_dash_"+Util.UID();

		Thread.run(function*(){
			var all_bugs = yield (ESQuery.run({
				"from":"bugs",
				"select":["bug_id","assigned_to"],
				"esfilter":{"and":[
					category.esfilter,
					teamFilter,
					Mozilla.BugStatus.Open.esfilter,
					Mozilla.CurrentRecords.esfilter
				]}
			}));

			category.bugs = all_bugs.list.select("bug_id");
			category.bugsCount = category.bugs.length;

			if (category.name =="Security" && category.bugsCount ==0) return;

			category.unassignedBugs = all_bugs.list.filter(function(b){return b.assigned_to!="nobody@mozilla.org"}).select("bug_id");
			category.unassignedBugsCount = category.unassignedBugs.length;
			category.bugsList = category.bugs.join(", ");
			category.bugsURL = Bugzilla.searchBugsURL(category.bugs);
			category.unassignedURL = Bugzilla.searchBugsURL(category.unassignedBugs);
			category.color = "grey";

			var TEMPLATE = new Template([
				'<td class="category">{{name}}</td>',
				'<td><div class="project"  style="background-color:{{color}}" href="{{bugsURL}}" bugsList="{{bugsList}}">' ,
//				'<div class="release">&nbsp;</div>',
				'<div class="count">{{bugsCount}}</div>',
				(category.unassignedBugs.length > 0 ? '<div class="unassigned"><a class="count_unassigned" href="{{unassignedURL}}">{{unassignedBugsCount}}</a></div>' : '') ,
				'</div></td>'
			]);

			var node = $("#"+uid);
			node.html(TEMPLATE.replace(category));
			addProjectClickers(node);

		});

		return '<tr id="'+uid+'"></tr>';   //RETURN PLACEHOLDER
	}//function
</script>


</BODY>
</HTML>




